<!doctypehtml><html lang="en"data-color-mode="dark"data-dark-theme="dark"><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><script>localStorage.theme&&document.documentElement.setAttribute("data-theme",localStorage.theme)</script><script src="https://fkoehler.org/theme/script.js?4f3a4ba4"></script><title>Fabian Köhler - Shipping a Scientific Software Using AppImage</title><meta charset="utf-8"><meta name="generator"content="Pelican"><meta name="viewport"content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color"content="#2e3440"><meta property="og:title"content="Fabian Köhler - Shipping a Scientific Software Using AppImage
"><meta property="og:description"content="Fabian Köhler's personal page"><meta property="og:locale"content="en_US"><link rel="stylesheet"href="https://fkoehler.org/theme/style.css?69884c8a"><link rel="stylesheet"title="syntax-light"href="https://fkoehler.org/theme/syntax-light.css?a347997e"disabled="disabled"><link rel="stylesheet"title="syntax-dark"href="https://fkoehler.org/theme/syntax-dark.css?37af4c5c"disabled="disabled"><link rel="icon"type="image/png"sizes="196x196"href="favicon-196.png"><meta name="msapplication-square70x70logo"content="mstile-icon-128.png"><meta name="msapplication-square150x150logo"content="mstile-icon-270.png"><meta name="msapplication-square310x310logo"content="mstile-icon-558.png"><meta name="msapplication-wide310x150logo"content="mstile-icon-558-270.png"><link rel="apple-touch-icon"href="apple-icon-180.png"><meta name="apple-mobile-web-app-capable"content="yes"><link rel="apple-touch-startup-image"href="apple-splash-2048-2732.jpg"media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-2732-2048.jpg"media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-1668-2388.jpg"media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-2388-1668.jpg"media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-1536-2048.jpg"media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-2048-1536.jpg"media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-1668-2224.jpg"media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-2224-1668.jpg"media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-1620-2160.jpg"media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-2160-1620.jpg"media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-1290-2796.jpg"media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-2796-1290.jpg"media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-1179-2556.jpg"media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-2556-1179.jpg"media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-1284-2778.jpg"media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-2778-1284.jpg"media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-1170-2532.jpg"media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-2532-1170.jpg"media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-1125-2436.jpg"media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-2436-1125.jpg"media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-1242-2688.jpg"media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-2688-1242.jpg"media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-828-1792.jpg"media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-1792-828.jpg"media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-1242-2208.jpg"media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-2208-1242.jpg"media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-750-1334.jpg"media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-1334-750.jpg"media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image"href="apple-splash-640-1136.jpg"media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image"href="apple-splash-1136-640.jpg"media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><meta name="description"content="AppImages are portable binary application packages that run in most Linux environment. We show how it can be employed to distribute a multi-executable scientific software package including the Intel runtime without having to hand out the source code."><meta name="keywords"content="Fortran,Scientific Software,AppImage,Docker,MKL,Intel,Deployment,Featured"><body id="top"><svg style="display:none"version="2.0"><defs><symbol id="icon-calendar"class="icon"><path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z"/></symbol><symbol id="icon-clock"class="icon"><path d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22C6.47,22 2,17.5 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/></symbol><symbol id="icon-linkedin"class="icon"><path d="M19 3A2 2 0 0 1 21 5V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V5A2 2 0 0 1 5 3H19M18.5 18.5V13.2A3.26 3.26 0 0 0 15.24 9.94C14.39 9.94 13.4 10.46 12.92 11.24V10.13H10.13V18.5H12.92V13.57C12.92 12.8 13.54 12.17 14.31 12.17A1.4 1.4 0 0 1 15.71 13.57V18.5H18.5M6.88 8.56A1.68 1.68 0 0 0 8.56 6.88C8.56 5.95 7.81 5.19 6.88 5.19A1.69 1.69 0 0 0 5.19 6.88C5.19 7.81 5.95 8.56 6.88 8.56M8.27 18.5V10.13H5.5V18.5H8.27Z"/></symbol><symbol id="icon-linkedin-head"class="icon"><path d="M19 3A2 2 0 0 1 21 5V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V5A2 2 0 0 1 5 3H19M18.5 18.5V13.2A3.26 3.26 0 0 0 15.24 9.94C14.39 9.94 13.4 10.46 12.92 11.24V10.13H10.13V18.5H12.92V13.57C12.92 12.8 13.54 12.17 14.31 12.17A1.4 1.4 0 0 1 15.71 13.57V18.5H18.5M6.88 8.56A1.68 1.68 0 0 0 8.56 6.88C8.56 5.95 7.81 5.19 6.88 5.19A1.69 1.69 0 0 0 5.19 6.88C5.19 7.81 5.95 8.56 6.88 8.56M8.27 18.5V10.13H5.5V18.5H8.27Z"/></symbol><symbol id="icon-github"class="icon"><path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"/></symbol><symbol id="icon-github-head"class="icon"><path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"/></symbol><symbol id="icon-tags"class="icon"><path d="M6.5 10C7.3 10 8 9.3 8 8.5S7.3 7 6.5 7 5 7.7 5 8.5 5.7 10 6.5 10M9 6L16 13L11 18L4 11V6H9M9 4H4C2.9 4 2 4.9 2 6V11C2 11.6 2.2 12.1 2.6 12.4L9.6 19.4C9.9 19.8 10.4 20 11 20S12.1 19.8 12.4 19.4L17.4 14.4C17.8 14 18 13.5 18 13C18 12.4 17.8 11.9 17.4 11.6L10.4 4.6C10.1 4.2 9.6 4 9 4M13.5 5.7L14.5 4.7L21.4 11.6C21.8 12 22 12.5 22 13S21.8 14.1 21.4 14.4L16 19.8L15 18.8L20.7 13L13.5 5.7Z"/></symbol><symbol id="icon-author"class="icon"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></symbol><symbol id="icon-category"class="icon"><path d="M14,8H10V6H14V8M20,4V20C20,21.11 19.11,22 18,22H6C4.89,22 4,21.11 4,20V4A2,2 0 0,1 6,2H18C19.11,2 20,2.9 20,4M18,13H6V20H18V13M18,4H6V11H18V4M14,15H10V17H14V15Z"></path></symbol><symbol id="icon-matrix"class="icon"><path d="M20.534 22.014V1.964h-1.047v-.961h2.09V23h-2.09v-.962ZM8.022 8.174v1.059h.03a3.09 3.09 0 0 1 1.024-.942 2.777 2.777 0 0 1 1.367-.334c.495 0 .95.097 1.355.29.41.19.722.53.935 1.017a3.274 3.274 0 0 1 .948-.908c.399-.263.874-.394 1.416-.394.415 0 .798.05 1.148.15.354.102.656.263.908.486.252.223.449.514.59.874.141.358.212.79.212 1.299v5.245h-2.15v-4.44c0-.264-.01-.512-.031-.743a1.582 1.582 0 0 0-.166-.607 1.01 1.01 0 0 0-.402-.41c-.176-.1-.417-.15-.722-.15-.302 0-.547.058-.735.173a1.265 1.265 0 0 0-.44.455c-.11.198-.18.414-.21.638-.038.238-.055.48-.055.722v4.365h-2.151v-4.4c0-.232-.005-.462-.015-.688a1.943 1.943 0 0 0-.128-.629.968.968 0 0 0-.379-.463c-.178-.115-.437-.174-.784-.174a1.604 1.604 0 0 0-.401.069 1.34 1.34 0 0 0-.485.257 1.51 1.51 0 0 0-.4.546c-.112.238-.168.55-.168.935v4.55H5.981V8.187ZM3.466 1.986v20.05h1.047v.961h-2.09V1h2.083v.96z"/></symbol><symbol id="icon-rss"class="icon"><path d="M6.18,15.64A2.18,2.18 0 0,1 8.36,17.82C8.36,19 7.38,20 6.18,20C5,20 4,19 4,17.82A2.18,2.18 0 0,1 6.18,15.64M4,4.44A15.56,15.56 0 0,1 19.56,20H16.73A12.73,12.73 0 0,0 4,7.27V4.44M4,10.1A9.9,9.9 0 0,1 13.9,20H11.07A7.07,7.07 0 0,0 4,12.93V10.1Z"></path></symbol><symbol id="icon-moon"class="icon"><path d="M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.83 4.94,4.93C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.14,4.21 8.06,5.04C7.79,7.9 8.75,10.87 10.95,13.06C13.14,15.26 16.1,16.22 18.97,15.95M17.33,17.97C14.5,17.81 11.7,16.64 9.53,14.5C7.36,12.31 6.2,9.5 6.04,6.68C3.23,9.82 3.34,14.64 6.35,17.66C9.37,20.67 14.19,20.78 17.33,17.97Z"/></symbol><symbol id="icon-sun"class="icon"><path d="M3.55,18.54L4.96,19.95L6.76,18.16L5.34,16.74M11,22.45C11.32,22.45 13,22.45 13,22.45V19.5H11M12,5.5A6,6 0 0,0 6,11.5A6,6 0 0,0 12,17.5A6,6 0 0,0 18,11.5C18,8.18 15.31,5.5 12,5.5M20,12.5H23V10.5H20M17.24,18.16L19.04,19.95L20.45,18.54L18.66,16.74M20.45,4.46L19.04,3.05L17.24,4.84L18.66,6.26M13,0.55H11V3.5H13M4,10.5H1V12.5H4M6.76,4.84L4.96,3.05L3.55,4.46L5.34,6.26L6.76,4.84Z"/></symbol></defs></svg><header class="page"><nav><div class="logo"><a class="menu"href="/index.html">Fabian Köhler</a> <label><input type="checkbox"id="theme-toggle"> <span><svg class="menu"id="theme-toggle-sun"viewBox="2 2 22 22"><use xlink:href="#icon-sun"/></svg> <svg class="menu"id="theme-toggle-moon"viewBox="2 2 22 22"><use xlink:href="#icon-moon"/></svg></span></label></div><ul class="menu"><li><a class="menu"href="/index.html">Home</a><li><a class="menu"href="/posts.html">Posts</a><li><a class="menu"href="/category/projects.html">Projects</a><li><a href="https://linkedin.com/in/fabian-koehler"aria-label="LinkedIn"><svg class="menu"viewBox="2 2 22 22"><use xlink:href="#icon-linkedin-head"/><title>LinkedIn Icon</title></svg></a><li><a href="https://github.com/f-koehler"aria-label="GitHub"><svg class="menu"viewBox="2 2 22 22"><use xlink:href="#icon-github-head"/><title>Github Icon</title></svg></a></ul></nav></header><main class="page"><article class="content"><h2>Shipping a Scientific Software Using AppImage</h2><div class="metadata"><div><svg class="metadata-icon"viewBox="2 2 22 22"><use xlink:href="#icon-author"/><title>Author:</title></svg> <a href="https://fkoehler.org/author/fabian-kohler.html">Fabian Köhler</a></div><svg class="metadata-icon"viewBox="2 2 22 22"><use xlink:href="#icon-calendar"/><title>Published:</title></svg> <time datetime="2021-03-30T12:32:00+02:00">2021-03-30 12:32</time><div><svg class="metadata-icon"viewBox="2 2 22 22"><use xlink:href="#icon-category"/><title>Categories:</title></svg> <a href="https://fkoehler.org/category/coding.html">Coding</a></div><div><svg class="metadata-icon"viewBox="2 2 22 22"><use xlink:href="#icon-tags"/><title>Tags:</title></svg> <a href="https://fkoehler.org/tag/fortran.html">Fortran,</a> <a href="https://fkoehler.org/tag/scientific-software.html">Scientific Software,</a> <a href="https://fkoehler.org/tag/appimage.html">AppImage,</a> <a href="https://fkoehler.org/tag/docker.html">Docker,</a> <a href="https://fkoehler.org/tag/mkl.html">MKL,</a> <a href="https://fkoehler.org/tag/intel.html">Intel,</a> <a href="https://fkoehler.org/tag/deployment.html">Deployment,</a> <a href="https://fkoehler.org/tag/featured.html">Featured</a></div></div><div class="color-fg-success"><p>At my current PhD position I am the sole maintainer of a complex scientific software (an implementation of the <a href="https://doi.org/10.1063/1.4993512">ML-MCTDHX algorithm</a>). Recently I found myself facing the challenge to distribute this package to users outside our group. Our code consists of two parts<ul><li>a python library used for setting up the problem and analyzing results<li>Fortran binaries that do the actual number crunching</ul><p>Distributing the Python was straightforward using the normal means. I just created a tarball using <a href="https://python-poetry.org/docs/cli/#build"><code>poetry build</code></a> which can be installed using <a href="https://pip.pypa.io/en/stable/">pip</a>. Shipping the Fortran part however was not so straightforward, for the following reasons<ul><li>The source code should not be shipped to the user.<li>The whole runtime (Intel runtime, <a href="https://software.intel.com/content/www/us/en/develop/tools/oneapi/components/onemkl.html">MKL</a> and system libraries) should be included, such that the software should run on any modern Linux platform<li>Avoid fiddling with environment variables (my first attempt was just to bundle everything up and update <code>PATH</code> and <code>LD_LIBRARY_PATH</code>, this was very error-prone, and I always forgot something).<li>The code should run on a Cluster where we cannot just install software like <a href="https://snapcraft.io/">snap</a> or <a href="https://flatpak.org/">flatpak</a>.<li>The usage should be dead simple. Many scientists are not so tech-savvy and often are not interested in learning (which is OK, sometimes we just need to get our research done).</ul><p>After looking at my options the solution became pretty clear – just build an <a href="https://appimage.org/">AppImage</a>. Using this tool chain you can package any Linux application into a single executable file.<p>In the following I describe how I obtained an AppImage from the existing <a href="https://cmake.org/">CMake build system</a> I wrote for the application. The procedure should be easy to adapt to other use cases/build systems as well. I test the result across multiple distributions using <a href="https://www.docker.com/">Docker</a>.<h2>Creating AppDir using CMake</h2><p>The first step of the process is to create an <a href="https://docs.appimage.org/packaging-guide/manual.html#creating-an-appdir-manually">AppDir</a> using CMake. Our <code>CMakeLists.txt</code> file already creates an installation target using the <a href="https://cmake.org/cmake/help/latest/command/install.html"><code>install</code></a> command. I added the following code<div class="highlight"><table class="highlight"><tr><td class="linenos"><pre>1</pre><td><pre class="highlight"><span class="hljs-keyword">install</span>(</pre><tr><td class="linenos"><pre>2</pre><td><pre class="highlight">  FILES</pre><tr><td class="linenos"><pre>3</pre><td><pre class="highlight">    $ENV{MKLROOT}/lib/intel64/libmkl_avx.so.<span class="hljs-number">1</span></pre><tr><td class="linenos"><pre>4</pre><td><pre class="highlight">    $ENV{MKLROOT}/lib/intel64/libmkl_avx2.so.<span class="hljs-number">1</span></pre><tr><td class="linenos"><pre>5</pre><td><pre class="highlight">    $ENV{MKLROOT}/lib/intel64/libmkl_avx512.so.<span class="hljs-number">1</span></pre><tr><td class="linenos"><pre>6</pre><td><pre class="highlight">    $ENV{MKLROOT}/lib/intel64/libmkl_avx512_mic.so.<span class="hljs-number">1</span></pre><tr><td class="linenos"><pre>7</pre><td><pre class="highlight">    $ENV{MKLROOT}/lib/intel64/libmkl_core.so.<span class="hljs-number">1</span></pre><tr><td class="linenos"><pre>8</pre><td><pre class="highlight">    $ENV{MKLROOT}/lib/intel64/libmkl_intel_lp64.so.<span class="hljs-number">1</span></pre><tr><td class="linenos"><pre>9</pre><td><pre class="highlight">    $ENV{MKLROOT}/lib/intel64/libmkl_sequential.so.<span class="hljs-number">1</span></pre><tr><td class="linenos"><pre>10</pre><td><pre class="highlight">    PERMISSIONS</pre><tr><td class="linenos"><pre>11</pre><td><pre class="highlight">      OWNER_READ OWNER_WRITE OWNER_EXECUTE</pre><tr><td class="linenos"><pre>12</pre><td><pre class="highlight">      GROUP_READ GROUP_EXECUTE</pre><tr><td class="linenos"><pre>13</pre><td><pre class="highlight">      WORLD_EXECUTE</pre><tr><td class="linenos"><pre>14</pre><td><pre class="highlight">    DESTINATION lib</pre><tr><td class="linenos"><pre>15</pre><td><pre class="highlight">    CONFIGURATIONS Release</pre><tr><td class="linenos"><pre>16</pre><td><pre class="highlight">)</pre></table></div><p>which installs the necessary Intel MKL libraries. By adding<div class="highlight"><table class="highlight"><tr><td class="linenos"><pre>1</pre><td><pre class="highlight"><span class="hljs-keyword">include</span>(InstallRequiredSystemLibraries)</pre></table></div><p>the rest of the Intel libraries including the Fortran runtime also gets bundled (see <a href="https://cmake.org/cmake/help/latest/module/InstallRequiredSystemLibraries.html">here</a>). The idea is now to perform a normal CMake build and install the targets using the <code>install</code> target (e.g. <code>make install</code>). It is important to set <code>CMAKE_INSTALL_PREFIX=/usr</code> as this is the installation prefix the AppImage tool chain expects. The path where the executables will be located can be set using the <code>DESTDIR</code> variable and should be set to the AppDir to create for AppImage, e.g. <code>DESTDIR=$PWD/build-appimage/AppDir</code>.<p>In our example we end up with a directory structure like this:<div class="highlight"><table class="highlight"><tr><td class="linenos"><pre>1</pre><td><pre class="highlight">qdtk.AppDir</pre><tr><td class="linenos"><pre>2</pre><td><pre class="highlight">└── usr</pre><tr><td class="linenos"><pre>3</pre><td><pre class="highlight">    ├── bin</pre><tr><td class="linenos"><pre>4</pre><td><pre class="highlight">    │   ├── qdtk_analysis.x</pre><tr><td class="linenos"><pre>5</pre><td><pre class="highlight">    │   ├── qdtk_expect.x</pre><tr><td class="linenos"><pre>6</pre><td><pre class="highlight">    │   └── qdtk_propagate.x</pre><tr><td class="linenos"><pre>7</pre><td><pre class="highlight">    └── lib</pre><tr><td class="linenos"><pre>8</pre><td><pre class="highlight">        ├── libchkp.so</pre><tr><td class="linenos"><pre>9</pre><td><pre class="highlight">        ├── libcilkrts.so</pre><tr><td class="linenos"><pre>10</pre><td><pre class="highlight">        ├── libcilkrts.so.5</pre><tr><td class="linenos"><pre>11</pre><td><pre class="highlight">        ├── libicaf.so</pre><tr><td class="linenos"><pre>12</pre><td><pre class="highlight">        ├── libifcoremt.so</pre><tr><td class="linenos"><pre>13</pre><td><pre class="highlight">        ├── libifcoremt.so.5</pre><tr><td class="linenos"><pre>14</pre><td><pre class="highlight">        ├── libifcore.so</pre><tr><td class="linenos"><pre>15</pre><td><pre class="highlight">        ├── libifcore.so.5</pre><tr><td class="linenos"><pre>16</pre><td><pre class="highlight">        ├── libifport.so</pre><tr><td class="linenos"><pre>17</pre><td><pre class="highlight">        ├── libifport.so.5</pre><tr><td class="linenos"><pre>18</pre><td><pre class="highlight">        ├── libimf.so</pre><tr><td class="linenos"><pre>19</pre><td><pre class="highlight">        ├── libintlc.so</pre><tr><td class="linenos"><pre>20</pre><td><pre class="highlight">        ├── libintlc.so.5</pre><tr><td class="linenos"><pre>21</pre><td><pre class="highlight">        ├── libiomp5.so</pre><tr><td class="linenos"><pre>22</pre><td><pre class="highlight">        ├── libiompstubs5.so</pre><tr><td class="linenos"><pre>23</pre><td><pre class="highlight">        ├── libirc.so</pre><tr><td class="linenos"><pre>24</pre><td><pre class="highlight">        ├── libirng.so</pre><tr><td class="linenos"><pre>25</pre><td><pre class="highlight">        ├── libmkl_avx2.so.1</pre><tr><td class="linenos"><pre>26</pre><td><pre class="highlight">        ├── libmkl_avx512_mic.so.1</pre><tr><td class="linenos"><pre>27</pre><td><pre class="highlight">        ├── libmkl_avx512.so.1</pre><tr><td class="linenos"><pre>28</pre><td><pre class="highlight">        ├── libmkl_avx.so.1</pre><tr><td class="linenos"><pre>29</pre><td><pre class="highlight">        ├── libmkl_core.so.1</pre><tr><td class="linenos"><pre>30</pre><td><pre class="highlight">        ├── libmkl_intel_lp64.so.1</pre><tr><td class="linenos"><pre>31</pre><td><pre class="highlight">        ├── libmkl_sequential.so.1</pre><tr><td class="linenos"><pre>32</pre><td><pre class="highlight">        ├── libmpx.so</pre><tr><td class="linenos"><pre>33</pre><td><pre class="highlight">        ├── libpdbx.so</pre><tr><td class="linenos"><pre>34</pre><td><pre class="highlight">        ├── libpdbx.so.5</pre><tr><td class="linenos"><pre>35</pre><td><pre class="highlight">        └── libsvml.so</pre></table></div><h2>Creating the AppImage</h2><p>According to the <a href="https://cmake.org/cmake/help/latest/module/InstallRequiredSystemLibraries.html">documentation</a>, the <code>appimagetool</code> command expects some extra files to be present. First we need to add an AppRun script which sets some environment variables and finally starts the software. The instructions recommend not to create it yourself. I just grabbed it from the <a href="https://github.com/AppImage/AppImageKit/blob/master/resources/AppRun">git repository</a>. Furthermore, a <code>.desktop</code> file is required (only the <code>Name</code>, <code>Exec</code>, <code>Icon</code>, <code>Type</code> and <code>Categories</code> fields have to be set). Mine looks like this:<div class="highlight"><table class="highlight"><tr><td class="linenos"><pre>1</pre><td><pre class="highlight"><span class="hljs-section">[Desktop Entry]</span></pre><tr><td class="linenos"><pre>2</pre><td><pre class="highlight"><span class="hljs-attr">Name</span>=qdtk</pre><tr><td class="linenos"><pre>3</pre><td><pre class="highlight"><span class="hljs-attr">Exec</span>=qdtk</pre><tr><td class="linenos"><pre>4</pre><td><pre class="highlight"><span class="hljs-attr">Icon</span>=qdtk</pre><tr><td class="linenos"><pre>5</pre><td><pre class="highlight"><span class="hljs-attr">Type</span>=Application</pre><tr><td class="linenos"><pre>6</pre><td><pre class="highlight"><span class="hljs-attr">Categories</span>=Science<span class="hljs-comment">;</span></pre></table></div><p>The <code>Exec</code> field specifies the executable that the AppImage will execute. In my case this is the <code>qdtk</code> script which I describe in the next step, that dispatches the actual Fortran executable. An icon is required (here one really starts to notice that AppImage mainly targets graphical applications). I just dropped a blank <code>256x256</code> PNG file called <code>qdtk.png</code> in the AppDir and everything was fine.<p>To dispatch the actual executable I added a small wrapper script under <code>usr/bin/qdtk</code> in the AppDir:<div class="highlight"><table class="highlight"><tr><td class="linenos"><pre>1</pre><td><pre class="highlight"><span class="hljs-meta">#!/bin/sh</span></pre><tr><td class="linenos"><pre>2</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>3</pre><td><pre class="highlight"><span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$#</span>"</span> -lt 1 ]; <span class="hljs-keyword">then</span></pre><tr><td class="linenos"><pre>4</pre><td><pre class="highlight">    <span class="hljs-built_in">echo</span> <span class="hljs-string">"usage: qdtk.AppImage {qdtk_propagate.x|qdtk_expect.x|qdtk_analysis.x} [OPTIONS]"</span></pre><tr><td class="linenos"><pre>5</pre><td><pre class="highlight">    <span class="hljs-built_in">exit</span> 1</pre><tr><td class="linenos"><pre>6</pre><td><pre class="highlight"><span class="hljs-keyword">else</span></pre><tr><td class="linenos"><pre>7</pre><td><pre class="highlight">    executable=<span class="hljs-variable">$1</span></pre><tr><td class="linenos"><pre>8</pre><td><pre class="highlight">    <span class="hljs-built_in">shift</span></pre><tr><td class="linenos"><pre>9</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>10</pre><td><pre class="highlight">    <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$executable</span>"</span> <span class="hljs-keyword">in</span></pre><tr><td class="linenos"><pre>11</pre><td><pre class="highlight">        qdtk_propagate.x|qdtk_expect.x|qdtk_analysis.x)</pre><tr><td class="linenos"><pre>12</pre><td><pre class="highlight">            <span class="hljs-variable">$executable</span> <span class="hljs-variable">$@</span></pre><tr><td class="linenos"><pre>13</pre><td><pre class="highlight">            ;;</pre><tr><td class="linenos"><pre>14</pre><td><pre class="highlight">        *)</pre><tr><td class="linenos"><pre>15</pre><td><pre class="highlight">            <span class="hljs-built_in">echo</span> <span class="hljs-string">"usage: qdtk.AppImage {qdtk_propagate.x|qdtk_expect.x|qdtk_analysis.x} [OPTIONS]"</span></pre><tr><td class="linenos"><pre>16</pre><td><pre class="highlight">            ;;</pre><tr><td class="linenos"><pre>17</pre><td><pre class="highlight">    <span class="hljs-keyword">esac</span></pre><tr><td class="linenos"><pre>18</pre><td><pre class="highlight"><span class="hljs-keyword">fi</span></pre></table></div><p>The first CLI option passed to <code>qdtk.AppImage</code> then specifies the executable (<code>qdtk_propagate.x</code>, <code>qdtk_expect.x</code> or <code>qdtk_analysis.x</code>) to call. All remaining parameters are forwarded to that program.<p>The files added to the AppDir in this second step are:<div class="highlight"><table class="highlight"><tr><td class="linenos"><pre>1</pre><td><pre class="highlight">qdtk.AppDir</pre><tr><td class="linenos"><pre>2</pre><td><pre class="highlight">├── AppRun</pre><tr><td class="linenos"><pre>3</pre><td><pre class="highlight">├── qdtk.desktop</pre><tr><td class="linenos"><pre>4</pre><td><pre class="highlight">├── qdtk.png</pre><tr><td class="linenos"><pre>5</pre><td><pre class="highlight">└── usr</pre><tr><td class="linenos"><pre>6</pre><td><pre class="highlight">    └── bin</pre><tr><td class="linenos"><pre>7</pre><td><pre class="highlight">        └── qdtk</pre></table></div><p>Now, we can finally build the AppImage by calling <code>appimagetool &lt;path-to-appdir&gt; qdtk.AppImage</code>. By calling <code>qdtk.AppImage qdtk_propagate.x</code> we can directly test it. Luckily everything is now working and neatly bundled including all dependencies.<h2>Testing Using Docker</h2><p>In order to be sure that the AppImage we just created works across multiple distributions. This can be easily achieved using Docker containers. However, most Docker images ship without <a href="https://github.com/libfuse/libfuse"><code>libfuse</code></a> which is required to mount and run the AppImage. Luckily AppImages can still be executed using the <code>--appimage-extract-and-run</code> flag by first extracting them. As an example, I use the command<div class="highlight"><table class="highlight"><tr><td class="linenos"><pre>1</pre><td><pre class="highlight">docker run \</pre><tr><td class="linenos"><pre>2</pre><td><pre class="highlight">    -v <span class="hljs-variable">$PWD</span>/build-appimage/qdtk.AppImage:/qdtk.AppImage \</pre><tr><td class="linenos"><pre>3</pre><td><pre class="highlight">    ubuntu:20.04 \</pre><tr><td class="linenos"><pre>4</pre><td><pre class="highlight">    /qdtk.AppImage --appimage-extract-and-run qdtk_propagate.x -h</pre></table></div><p>to test the AppImage under <a href="https://releases.ubuntu.com/20.04/">Ubuntu 20.04 LTS</a>. I successfully tested my AppImage across multiple distributions.<p>In the future I will create a repository of <a href="https://docs.docker.com/engine/reference/builder/"><code>Dockerfile</code></a>s that add <code>libfuse</code> to the images of various distributions. I will update this article accordingly once I found the time to do so.<h2>Conclusions</h2><p>Preparing an AppImage from our existing CMake project was surprisingly simple. Everything I described should also work similarly for other build systems. Now I have a nice self-contained package with all batteries included that I can just pass to the user. At some points I noticed that the AppImage tool chain focuses on graphical desktop applications. However, all these hurdles were easy to overcome.<p>My full script (executed from the project root directory, where <code>CMakeLists.txt</code> is located) is attached below. Maybe it can serve you as a basis for your own experiments with AppImage. It should be easy enough to adapt it to your use case.<div class="highlight"><table class="highlight"><tr><td class="linenos"><pre>1</pre><td><pre class="highlight"><span class="hljs-meta">#!/bin/bash</span></pre><tr><td class="linenos"><pre>2</pre><td><pre class="highlight"><span class="hljs-built_in">set</span> -eu -o pipefail</pre><tr><td class="linenos"><pre>3</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>4</pre><td><pre class="highlight"><span class="hljs-comment"># use all available cores for the compilation</span></pre><tr><td class="linenos"><pre>5</pre><td><pre class="highlight"><span class="hljs-built_in">export</span> CMAKE_BUILD_PARALLEL_LEVEL=$(<span class="hljs-built_in">nproc</span> --all)</pre><tr><td class="linenos"><pre>6</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>7</pre><td><pre class="highlight"><span class="hljs-comment"># generate a Makefile build system in the folder build-appimage/cmake</span></pre><tr><td class="linenos"><pre>8</pre><td><pre class="highlight">cmake \</pre><tr><td class="linenos"><pre>9</pre><td><pre class="highlight">    -G <span class="hljs-string">"Unix Makefiles"</span> \</pre><tr><td class="linenos"><pre>10</pre><td><pre class="highlight">    -S <span class="hljs-variable">$PWD</span> \</pre><tr><td class="linenos"><pre>11</pre><td><pre class="highlight">    -B <span class="hljs-variable">$PWD</span>/build-appimage/cmake \</pre><tr><td class="linenos"><pre>12</pre><td><pre class="highlight">    -DCMAKE_BUILD_TYPE:STRING=Release \</pre><tr><td class="linenos"><pre>13</pre><td><pre class="highlight">    -DCMAKE_Fortran_COMPILER:STRING=ifort \</pre><tr><td class="linenos"><pre>14</pre><td><pre class="highlight">    -DCMAKE_INSTALL_PREFIX=/usr \</pre><tr><td class="linenos"><pre>15</pre><td><pre class="highlight">    -DENABLE_MKL:BOOL=ON</pre><tr><td class="linenos"><pre>16</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>17</pre><td><pre class="highlight"><span class="hljs-comment"># run the parallel build</span></pre><tr><td class="linenos"><pre>18</pre><td><pre class="highlight"><span class="hljs-built_in">nice</span> -n 19 cmake --build build-appimage/cmake</pre><tr><td class="linenos"><pre>19</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>20</pre><td><pre class="highlight"><span class="hljs-comment"># install binaries into the AppDir</span></pre><tr><td class="linenos"><pre>21</pre><td><pre class="highlight">make -C build-appimage/cmake install DESTDIR=<span class="hljs-variable">$PWD</span>/build-appimage/qdtk.AppDir</pre><tr><td class="linenos"><pre>22</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>23</pre><td><pre class="highlight"><span class="hljs-comment"># copy extra files for AppImage as well as the wrapper script</span></pre><tr><td class="linenos"><pre>24</pre><td><pre class="highlight"><span class="hljs-built_in">cp</span> -r AppDir/*  build-appimage/qdtk.AppDir/</pre><tr><td class="linenos"><pre>25</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>26</pre><td><pre class="highlight"><span class="hljs-comment"># remove spurious home directory (left over from arpack ExternalProject</span></pre><tr><td class="linenos"><pre>27</pre><td><pre class="highlight"><span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> figure out how to prevent this from happening</span></pre><tr><td class="linenos"><pre>28</pre><td><pre class="highlight"><span class="hljs-built_in">rm</span> -rf build-appimage/qdtk.AppDir/home</pre><tr><td class="linenos"><pre>29</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>30</pre><td><pre class="highlight"><span class="hljs-comment"># ensure that AppRun and the wrapper script remain executable</span></pre><tr><td class="linenos"><pre>31</pre><td><pre class="highlight"><span class="hljs-comment"># AppImage does not preserve the permissions of these files</span></pre><tr><td class="linenos"><pre>32</pre><td><pre class="highlight"><span class="hljs-built_in">chmod</span> a+x build-appimage/qdtk.AppDir/AppRun</pre><tr><td class="linenos"><pre>33</pre><td><pre class="highlight"><span class="hljs-built_in">chmod</span> a+x build-appimage/qdtk.AppDir/usr/bin/qdtk</pre><tr><td class="linenos"><pre>34</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>35</pre><td><pre class="highlight"><span class="hljs-comment"># build the AppImage</span></pre><tr><td class="linenos"><pre>36</pre><td><pre class="highlight">appimagetool build-appimage/qdtk.AppDir build-appimage/qdtk.AppImage</pre><tr><td class="linenos"><pre>37</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>38</pre><td><pre class="highlight"><span class="hljs-comment"># test the AppImage across multiple distros</span></pre><tr><td class="linenos"><pre>39</pre><td><pre class="highlight"><span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> build docker images including the libfuse library to avoid the</span></pre><tr><td class="linenos"><pre>40</pre><td><pre class="highlight"><span class="hljs-comment"># extraction</span></pre><tr><td class="linenos"><pre>41</pre><td><pre class="highlight">docker run \</pre><tr><td class="linenos"><pre>42</pre><td><pre class="highlight">    -v <span class="hljs-variable">$PWD</span>/build-appimage/qdtk.AppImage:/qdtk.AppImage \</pre><tr><td class="linenos"><pre>43</pre><td><pre class="highlight">    ubuntu:16.04 \</pre><tr><td class="linenos"><pre>44</pre><td><pre class="highlight">    /qdtk.AppImage --appimage-extract-and-run qdtk_propagate.x -h</pre><tr><td class="linenos"><pre>45</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>46</pre><td><pre class="highlight">docker run \</pre><tr><td class="linenos"><pre>47</pre><td><pre class="highlight">    -v <span class="hljs-variable">$PWD</span>/build-appimage/qdtk.AppImage:/qdtk.AppImage \</pre><tr><td class="linenos"><pre>48</pre><td><pre class="highlight">    ubuntu:18.04 \</pre><tr><td class="linenos"><pre>49</pre><td><pre class="highlight">    /qdtk.AppImage --appimage-extract-and-run qdtk_propagate.x -h</pre><tr><td class="linenos"><pre>50</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>51</pre><td><pre class="highlight">docker run \</pre><tr><td class="linenos"><pre>52</pre><td><pre class="highlight">    -v <span class="hljs-variable">$PWD</span>/build-appimage/qdtk.AppImage:/qdtk.AppImage \</pre><tr><td class="linenos"><pre>53</pre><td><pre class="highlight">    ubuntu:20.04 \</pre><tr><td class="linenos"><pre>54</pre><td><pre class="highlight">    /qdtk.AppImage --appimage-extract-and-run qdtk_propagate.x -h</pre><tr><td class="linenos"><pre>55</pre><td><pre class="highlight"></pre><tr><td class="linenos"><pre>56</pre><td><pre class="highlight">docker run \</pre><tr><td class="linenos"><pre>57</pre><td><pre class="highlight">    -v <span class="hljs-variable">$PWD</span>/build-appimage/qdtk.AppImage:/qdtk.AppImage \</pre><tr><td class="linenos"><pre>58</pre><td><pre class="highlight">    archlinux \</pre><tr><td class="linenos"><pre>59</pre><td><pre class="highlight">    /qdtk.AppImage --appimage-extract-and-run qdtk_propagate.x -h</pre></table></div></div><div id="utterances-light"><script src="https://utteranc.es/client.js"repo="f-koehler/blog-comments"issue-term="pathname"theme="github-light"crossorigin="anonymous"async></script></div><div id="utterances-dark"><script src="https://utteranc.es/client.js"repo="f-koehler/blog-comments"issue-term="pathname"theme="github-dark"crossorigin="anonymous"async></script></div></article></main><footer class="page"><span><a href="https://fkoehler.org/pages/impressum.html">Impressum</a> </span><span><i>© Fabian Köhler</i> </span><a id="top-link"href="#top"><svg width="32px"height="32px"viewBox="2 2 22 22"><path d="M12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22M17,14L12,9L7,14H17Z"/></svg></a></footer>